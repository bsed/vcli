#!/bin/bash

USER=jensg-st
DIST=dev
COMP=main
VER=test-@VERSION_MAJOR@.@VERSION_MINOR@.@VERSION_PATCH@
REL=v$VER-alpha
ORG=sisatech
REPO=vorteil
PACK=vcli
ARCH=amd64
DEB=$PACK-$VER-$1.deb
DEB_URL="$PACK"_"$VER"_$ARCH.deb

declare -r SSH_FILE="$(mktemp -u $HOME/.ssh/XXXXX)"

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Decrypt the file containing the private key
# (Note: this is the same as what is generated by the Travis CLI at step 2.5)

openssl aes-256-cbc \
  -K $encrypted_XXXXXXXXXXXX_key \
  -iv $encrypted_XXXXXXXXXXXX_iv \
  -in ".travis/github_deploy_key.enc" \
  -out "$SSH_FILE" -d

# - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

# Enable SSH authentication

chmod 600 "$SSH_FILE" \
  && printf "%s\n" \
       "Host github.com" \
       "  IdentityFile $SSH_FILE" \
       "  LogLevel ERROR" >> ~/.ssh/config

# upload binary to git release
echo "uploading binary to git release draft $REL...\n"

if [curl https://api.github.com/repos/sisatech/vcli/releases/tags/$REL 2>&1 | grep '"message": "Not Found"']; then
	echo "release not found, creating..."
	curl -X POST --data '{"tag_name":"$REL","target_commitish":"master","name":"$REL","body":"Automatically generated release.","draft":true,"prerelease":true}' https://api.github.com/repos/sisatech/vcli/releases
fi

ID=$(curl https://api.github.com/repos/sisatech/vcli/releases/tags/$REL 2>&1 | grep '"id":' | head -1 | tr -d '[:space:][,]' | cut -d':' -f2)

if [ "$1" == "Linux" ]; then
TARNAME=$REL-linux.tar.gz
fi

if [ "$1" != "Linux" ]; then
TARNAME=$REL-darwin.tar.gz
fi

tar -czvf $TARNAME $PACK
echo "uploading binary..."
curl -X POST https://api.github.com/repos/sisatech/vcli/releases/$ID/assets?name=$TARNAME --data @$TARNAME

# upload binary to google cloud
echo "downloading quickstart package from google cloud..."

curl https://storage.googleapis.com/vorteil/vcli-demo-platforms/demo.tar.gz > quickstart.tar.gz

tar -xzvf quickstart.tar.gz

cp $PACK demo/vcli

if [ "$1" == "Linux" ]; then
TARNAME=test_vcli_linux.tar.gz
fi

if [ "$1" != "Linux" ]; then
TARNAME=test_vcli_darwin.tar.gz
fi

tar -czvf vcli_linux.tar.gz demo

curl -X POST --data @$TARNAME https://www.googleapis.com/upload/storage/v1/b/vorteil/o?uploadType=media&name=vcli-demo-platforms/$TARNAME
